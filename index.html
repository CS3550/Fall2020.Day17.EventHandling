<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Event Handling</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            margin-top: 2rem;
        }

        button {
            font-family: monospace;
            font-size: 3rem;
        }
    </style>
</head>

<body>
    <div>
        <div style="text-align:center;margin:1rem;">
            <button onclick="undo()" id="undo">Undo</button>
            <button onclick="redo()" id="redo">Redo</button>
        </div>


        <table style="margin:0 auto;">
            <tr>
                <td><button id="0" onclick="clicker(0)"></button></td>
                <td><button id="1" onclick="clicker(1)"></button></td>
                <td><button id="2" onclick="clicker(2)"></button></td>
            </tr>
            <tr>
                <td><button id="3" onclick="clicker(3)"></button></td>
                <td><button id="4" onclick="clicker(4)"></button></td>
                <td><button id="5" onclick="clicker(5)"></button></td>
            </tr>
            <tr>
                <td><button id="6" onclick="clicker(6)"></button></td>
                <td><button id="7" onclick="clicker(7)"></button></td>
                <td><button id="8" onclick="clicker(8)"></button></td>
            </tr>
        </table>

    </div>
    <div style="text-align: center;margin:1rem;">
        <textarea id="log" rows=15 cols=50></textarea>
    </div>



    <script>
        let X = "X";
        let O = "O";
        let BLANK = "&nbsp;";
        let BOARD_FULL = "BOARD FULL";

        let DO = "DO";
        let UNDO  = "UNDO";
        let REDO = "REDO";

        let undoStack = [];
        let redoStack = [];
        let listeners = [];

        function updateButtons(command) {
            for (let i = 0; i < 9; i++) {
                document.getElementById("" + i).innerHTML = command.model.model[i];
            }
        }

        function updateUndoRedo() {
            let undoElement = document.getElementById("undo");
            let redoElement = document.getElementById("redo");

            undoElement.disabled = undoStack.length == 0;
            redoElement.disabled = redoStack.length == 0;

            if(undoStack.length == 0)
                undoElement.innerHTML = "Undo"
            else
                undoElement.innerHTML = "Undo: " + undoStack[undoStack.length - 1].undoString();

            if(redoStack.length == 0)
                redoElement.innerHTML = "Redo"
            else
                redoElement.innerHTML = "Redo: " + redoStack[redoStack.length - 1].doString();


            
        }

        function updateLog(command, method, string){
            document.getElementById("log").innerHTML += `${string} (${method})\n`; 
        }

        function undo() {
            if (undoStack.length == 0) return;
            let command = undoStack.splice(undoStack.length - 1, 1)[0];
            command.undo();
            let string = command.undoString();
            redoStack.push(command);
            handleEvent("undoRedo", null, UNDO, string);
            handleEvent(command.constructor.name, command, UNDO, string);
        }

        function redo() {
            if (redoStack.length == 0) return;
            let command = redoStack.splice(redoStack.length - 1, 1)[0];
            command.do();
            let string = command.doString();
            undoStack.push(command);
            handleEvent("undoRedo", null, REDO, string);
            handleEvent(command.constructor.name, command, REDO, string);
        }

        function doCommand(command) {
            command.do();
            let string = command.doString();
            undoStack.push(command);
            redoStack = [];
            handleEvent("undoRedo", null, DO, string)
            handleEvent(command.constructor.name, command, DO, string);
        }

        function handleEvent(name, params, method, description) {
            for (let listener of listeners) {
                if (listener.name == name) {
                    listener.fn(params, method, description);
                }
            }
        }



        class Model {
            constructor() {
                this.model = []
                for (let i = 0; i < 9; i++) {
                    this.model[i] = BLANK;
                }
            }
        }

        class ClickCommand {
            constructor(model, index, value) {
                if (!model) return;
                this.model = model;
                this.index = index;
                this.value = value;
                this.originalValue = model.model[index];
            }
            do() {
                this.model.model[this.index] = this.value;
            }
            doString(){
                return `Set the value of ${this.index} to ${this.value}.`;
            }
            undo() {
                this.model.model[this.index] = this.originalValue;
            }
            undoString(){
                return `Set the value of ${this.index} to ${this.originalValue}.`;
            }
        }

        let model = new Model();
        updateButtons({ model: model });
        updateUndoRedo();

        function clicker(index) {
            let turn = getTurn();
            if (turn != BOARD_FULL) {
                if (model.model[index] == BLANK) {
                    let clickCommand = new ClickCommand(model, index, turn);
                    doCommand(clickCommand)
                }
            }
        }

        function getTurn() {
            let countX = 0;
            let countO = 0;

            for (let i = 0; i < 9; i++) {
                if (model.model[i] == X)
                    countX++;
                if (model.model[i] == O)
                    countO++;
            }

            if (countX + countO == 9)
                return BOARD_FULL;
            else if (countX == countO)
                return X;
            else return O;
        }

        listeners.push({name:new ClickCommand().constructor.name, fn:updateButtons});
        listeners.push({name: new ClickCommand().constructor.name, fn:updateLog});
        listeners.push({name: "undoRedo", fn:updateUndoRedo});




    </script>

</body>

</html>